<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    h3 {
      margin: 0 0 10px 0;
      color: #333;
    }
    .user-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .user-item {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .user-item:last-child {
      border-bottom: none;
    }
    .user-item:hover {
      background-color: #f5f5f5;
    }
    .user-item.selected {
      background-color: #E8F0FE;
      border-left: 3px solid #4285F4;
    }
    .user-name {
      font-weight: bold;
      color: #333;
    }
    .sheet-name {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
    .buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 10px;
    }
    button {
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-primary {
      background-color: #4285F4;
      color: white;
      border: none;
    }
    .btn-primary:hover {
      background-color: #3367D6;
    }
    .btn-secondary {
      background-color: white;
      color: #333;
      border: 1px solid #ddd;
    }
    .btn-secondary:hover {
      background-color: #f5f5f5;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .empty {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    .error {
      color: #D93025;
      padding: 10px;
      background-color: #FCE8E6;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h3>選擇使用者</h3>
    <div id="loading" class="loading">載入使用者清單中...</div>
    <div id="userList" class="user-list" style="display: none;"></div>
    <div id="empty" class="empty" style="display: none;">
      沒有可用的使用者試算表<br>
      <small>請先建立使用者試算表</small>
    </div>
    <div id="error" class="error" style="display: none;"></div>
    <div class="buttons">
      <button class="btn-secondary" onclick="google.script.host.close()">取消</button>
      <button class="btn-primary" id="selectBtn" onclick="selectUser()" disabled>選擇</button>
    </div>
  </div>

  <script>
    let users = [];
    let selectedIndex = -1;

    // 載入使用者清單
    google.script.run
      .withSuccessHandler(showUsers)
      .withFailureHandler(showError)
      .getUserList();

    function showUsers(userList) {
      users = userList;
      document.getElementById('loading').style.display = 'none';

      if (users.length === 0) {
        document.getElementById('empty').style.display = 'block';
        return;
      }

      const container = document.getElementById('userList');
      container.style.display = 'block';
      container.innerHTML = '';

      users.forEach((user, index) => {
        const item = document.createElement('div');
        item.className = 'user-item';
        item.onclick = function() { selectItem(index); };
        item.innerHTML = `
          <div class="user-name">${user.name}</div>
          <div class="sheet-name">工作表: ${user.sheetName}</div>
        `;
        container.appendChild(item);
      });
    }

    function showError(error) {
      document.getElementById('loading').style.display = 'none';
      const errorDiv = document.getElementById('error');
      errorDiv.style.display = 'block';
      errorDiv.textContent = '載入失敗: ' + (error.message || error);
    }

    function selectItem(index) {
      // 移除之前的選取
      const items = document.querySelectorAll('.user-item');
      items.forEach(item => item.classList.remove('selected'));

      // 選取新的
      items[index].classList.add('selected');
      selectedIndex = index;

      // 啟用選擇按鈕
      document.getElementById('selectBtn').disabled = false;
    }

    function selectUser() {
      if (selectedIndex < 0 || selectedIndex >= users.length) {
        return;
      }

      const user = users[selectedIndex];
      const selectBtn = document.getElementById('selectBtn');
      selectBtn.disabled = true;
      selectBtn.textContent = '載入中...';

      // 設定目標試算表
      google.script.run
        .withSuccessHandler(function() {
          // 關閉對話框並打開 sidebar
          google.script.host.close();
          google.script.run.showTaskSidebar();
        })
        .withFailureHandler(function(error) {
          selectBtn.disabled = false;
          selectBtn.textContent = '選擇';
          alert('設定失敗: ' + error.message);
        })
        .setTargetSpreadsheet(user.spreadsheetId, user.sheetName);
    }
  </script>
</body>
</html>
