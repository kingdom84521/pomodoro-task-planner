<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 15px;
      margin: 0;
      font-size: 13px;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    h3 {
      margin: 0 0 5px 0;
      color: #333;
      font-size: 16px;
    }
    .stats-bar {
      background-color: #E8F0FE;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
      font-size: 12px;
      color: #1967D2;
    }
    .stats-bar strong {
      font-size: 16px;
    }

    /* ä»»å‹™é¸æ“‡é é¢ */
    .task-list {
      max-height: 400px;
      overflow-y: auto;
    }
    .task-item {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .task-item:hover {
      border-color: #4285F4;
      background-color: #F8F9FA;
    }
    .task-item.selected {
      border-color: #4285F4;
      background-color: #E8F0FE;
    }
    .task-name {
      font-weight: bold;
      color: #333;
      margin-bottom: 4px;
    }
    .task-meta {
      font-size: 11px;
      color: #666;
    }
    .task-status {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      margin-right: 5px;
    }
    .task-status.pending {
      background-color: #FEF7E0;
      color: #B36200;
    }
    .task-status.in-progress {
      background-color: #E6F4EA;
      color: #1E8E3E;
    }
    .empty-message {
      text-align: center;
      padding: 30px;
      color: #999;
    }

    /* ä»»å‹™åˆ†é¡æ¨™ç±¤ */
    .task-category {
      background-color: #E8F0FE;
      color: #1967D2;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      margin-right: 5px;
      display: inline-block;
    }

    .task-category.warning {
      background-color: #FCE8E6;
      color: #D93025;
      font-weight: bold;
    }

    .task-item.category-warning {
      border-left: 3px solid #D93025;
      background-color: #FFF8F7;
    }

    /* åˆ†é¡è­¦å‘Šæ©«å¹… */
    .category-warning-banner {
      background-color: #FCE8E6;
      color: #D93025;
      padding: 12px;
      border-radius: 4px;
      border-left: 4px solid #D93025;
      margin-bottom: 15px;
      font-size: 12px;
      line-height: 1.5;
      display: none;
    }

    .category-warning-banner strong {
      font-weight: bold;
      color: #B31412;
    }

    /* ç•ªèŒ„é˜è¨ˆæ™‚é é¢ */
    .timer-page {
      display: none;
    }
    .timer-display {
      text-align: center;
      padding: 30px 0;
    }
    .timer-time {
      font-size: 48px;
      font-weight: bold;
      color: #333;
      font-family: monospace;
    }
    .timer-task {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
      word-break: break-word;
    }
    .timer-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .timer-btn {
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      border: none;
      min-width: 80px;
    }
    .btn-start {
      background-color: #1E8E3E;
      color: white;
    }
    .btn-start:hover {
      background-color: #137333;
    }
    .btn-pause {
      background-color: #FBBC04;
      color: #333;
    }
    .btn-pause:hover {
      background-color: #F9AB00;
    }
    .btn-stop {
      background-color: #D93025;
      color: white;
    }
    .btn-stop:hover {
      background-color: #C5221F;
    }
    .btn-back {
      background-color: #5F6368;
      color: white;
    }
    .btn-back:hover {
      background-color: #4D5156;
    }
    .timer-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* é€²åº¦æ¢ */
    .progress-container {
      margin: 20px 0;
    }
    .progress-bar {
      height: 8px;
      background-color: #E0E0E0;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background-color: #4285F4;
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    /* è¨Šæ¯ */
    .message {
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
      display: none;
      text-align: center;
    }
    .message.success {
      background-color: #E6F4EA;
      color: #1E8E3E;
      display: block;
    }
    .message.error {
      background-color: #FCE8E6;
      color: #D93025;
      display: block;
    }
    .message.info {
      background-color: #E8F0FE;
      color: #1967D2;
      display: block;
    }

    .loading {
      text-align: center;
      padding: 30px;
      color: #666;
    }

    /* å‡æ—¥æç¤º */
    .holiday-notice {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }
    .holiday-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    /* é•·æŒ‰åŠ ç­æŒ‰éˆ• */
    .overtime-btn {
      position: relative;
      margin-top: 20px;
      padding: 12px 24px;
      border: 2px solid #FF6B35;
      border-radius: 8px;
      background-color: transparent;
      color: #FF6B35;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      overflow: hidden;
      transition: color 0.3s ease;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
    }
    .overtime-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 0%;
      height: 100%;
      background-color: #FF6B35;
      transition: width 0s linear;
      z-index: -1;
    }
    .overtime-btn.filling::before {
      width: 100%;
      transition: width 1.5s linear;
    }
    .overtime-btn.filled {
      color: white;
      background-color: #FF6B35;
    }
    .overtime-btn:hover {
      box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
    }
    .overtime-hint {
      font-size: 11px;
      color: #999;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="message" class="message"></div>
    <div id="loading" class="loading">è¼‰å…¥ä¸­...</div>

    <!-- å‡æ—¥æç¤º -->
    <div id="holidayNotice" class="holiday-notice" style="display: none;">
      <div class="holiday-icon">ğŸ–ï¸</div>
      <div>ä»Šå¤©æ˜¯å‡æ—¥</div>
      <div style="font-size: 12px; margin-top: 10px;">å¥½å¥½ä¼‘æ¯å§ï¼</div>
      <button class="overtime-btn" id="overtimeBtn">ğŸ’ª æˆ‘è¦åŠ ç­</button>
      <div class="overtime-hint">é•·æŒ‰ 1.5 ç§’å•Ÿå‹•åŠ ç­æ¨¡å¼</div>
    </div>

    <!-- ä»»å‹™é¸æ“‡é é¢ -->
    <div id="taskSelectPage" style="display: none;">
      <div id="statsBar" class="stats-bar"></div>
      <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0;">
        <div style="font-weight: bold;">é¸æ“‡è¦é€²è¡Œçš„ä»»å‹™ï¼š</div>
        <button onclick="showSettingsDialog()" style="padding: 4px 8px; font-size: 11px; cursor: pointer; border: 1px solid #ddd; border-radius: 3px; background: white;">âš™ï¸ è¨­å®š</button>
      </div>
      <div id="taskList" class="task-list"></div>
    </div>

    <!-- è¨­å®šå°è©±æ¡† -->
    <div id="settingsDialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
      <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; width: 250px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
        <h4 style="margin: 0 0 15px 0;">ç•ªèŒ„é˜è¨­å®š</h4>
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: bold;">å·¥ä½œæ™‚é–“ï¼ˆåˆ†é˜ï¼‰</label>
          <input type="number" id="workDurationInput" min="5" max="120" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;" />
          <div style="font-size: 11px; color: #666; margin-top: 4px;">ç¯„åœï¼š<span id="durationRange"></span></div>
        </div>
        <div id="settingsMessage" class="message" style="margin-bottom: 10px;"></div>
        <div style="display: flex; gap: 10px;">
          <button onclick="closeSettingsDialog()" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">å–æ¶ˆ</button>
          <button onclick="saveSettings()" style="flex: 1; padding: 8px; border: none; border-radius: 4px; background: #4285F4; color: white; cursor: pointer;">å„²å­˜</button>
        </div>
      </div>
    </div>

    <!-- ç•ªèŒ„é˜è¨ˆæ™‚é é¢ -->
    <div id="timerPage" class="timer-page">
      <!-- åˆ†é¡è­¦å‘Šæ©«å¹… -->
      <div id="categoryWarningBanner" class="category-warning-banner">
        âš ï¸ <strong>æ³¨æ„</strong>ï¼šæ­¤ä»»å‹™çš„åˆ†é¡ã€Œ<span id="warningCategory"></span>ã€åœ¨æœ¬åŠå¹´çš„è³‡æºé…æ¯”å·²è¶…éä¸Šé™ <span id="warningLimit"></span>%ï¼Œç›®å‰ä½¿ç”¨ç‡ç‚º <span id="warningUsed"></span>%ã€‚å»ºè­°å„ªå…ˆè™•ç†å…¶ä»–åˆ†é¡çš„ä»»å‹™ã€‚
      </div>

      <div class="timer-display">
        <div class="timer-time" id="timerDisplay">30:00</div>
        <div class="timer-task" id="currentTaskName"></div>
      </div>
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
      </div>
      <div class="timer-controls">
        <button class="timer-btn btn-start" id="startBtn" onclick="startTimer()">é–‹å§‹</button>
        <button class="timer-btn btn-pause" id="pauseBtn" onclick="pauseTimer()" disabled>æš«åœ</button>
        <button class="timer-btn btn-stop" id="stopBtn" onclick="stopTimer()" disabled>åœæ­¢</button>
        <button class="timer-btn btn-back" id="backBtn" onclick="goBack()">è¿”å›</button>
      </div>
    </div>
  </div>

  <script>
    // ç‹€æ…‹
    let tasks = [];
    let selectedTask = null;
    let workDuration = 30; // åˆ†é˜
    let timeRemaining = 0; // ç§’
    let timerInterval = null;
    let isRunning = false;
    let isPaused = false;
    let startTime = null;
    let isOvertimeMode = false; // åŠ ç­æ¨¡å¼

    // é•·æŒ‰åŠ ç­æŒ‰éˆ•ç‹€æ…‹
    let overtimePressTimer = null;
    let isOvertimePressed = false;

    // åœæ­¢ç¢ºèªç‹€æ…‹
    let isStopConfirming = false;

    // è¼•é‡ç´šæª¢æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°ä»»å‹™æ¸…å–®
    let refreshCheckInterval = null;
    const REFRESH_CHECK_INTERVAL = 5000; // æ¯ 5 ç§’æª¢æŸ¥ä¸€æ¬¡ï¼ˆè¼•é‡ç´šï¼‰

    // è¨­å®šç›¸é—œ
    let minWorkDuration = 5;
    let maxWorkDuration = 120;
    let defaultWorkDuration = 30;

    // å„²å­˜ç‹€æ…‹åˆ°å¾Œç«¯
    function saveState() {
      const state = {
        selectedTask: selectedTask,
        isRunning: isRunning,
        isPaused: isPaused,
        isOvertimeMode: isOvertimeMode,
        startTime: startTime ? startTime.toISOString() : null,
        timeRemaining: timeRemaining,
        workDuration: workDuration,
        savedAt: new Date().toISOString(),
        // å¦‚æœæ­£åœ¨è¨ˆæ™‚ï¼Œè¨˜éŒ„è¨ˆæ™‚é–‹å§‹çš„æ™‚é–“é»ä»¥ä¾¿è¨ˆç®—ç¶“éæ™‚é–“
        timerStartedAt: (isRunning && !isPaused) ? new Date().toISOString() : null
      };

      google.script.run
        .withFailureHandler(function(err) {
          console.error('å„²å­˜ç‹€æ…‹å¤±æ•—:', err);
        })
        .savePomodoroState(state);
    }

    // æ¸…é™¤ç‹€æ…‹
    function clearState() {
      google.script.run.clearPomodoroState();
    }

    // åˆå§‹åŒ–é•·æŒ‰åŠ ç­æŒ‰éˆ•
    function initOvertimeButton() {
      const btn = document.getElementById('overtimeBtn');
      if (!btn) return;

      const HOLD_DURATION = 1500; // 1.5 ç§’

      // é–‹å§‹æŒ‰å£“
      function startPress(e) {
        e.preventDefault();
        if (isOvertimePressed) return;

        isOvertimePressed = true;
        btn.classList.add('filling');

        overtimePressTimer = setTimeout(() => {
          // é•·æŒ‰å®Œæˆ
          btn.classList.remove('filling');
          btn.classList.add('filled');

          // è§¸ç™¼åŠ ç­æ¨¡å¼
          setTimeout(() => {
            activateOvertimeMode();
          }, 200);
        }, HOLD_DURATION);
      }

      // çµæŸæŒ‰å£“
      function endPress(e) {
        e.preventDefault();
        if (!isOvertimePressed) return;

        isOvertimePressed = false;
        clearTimeout(overtimePressTimer);

        // å¦‚æœé‚„æ²’å®Œæˆå°±é‡ç½®å‹•ç•«
        if (!btn.classList.contains('filled')) {
          btn.classList.remove('filling');
        }
      }

      // æ»‘é¼ äº‹ä»¶
      btn.addEventListener('mousedown', startPress);
      btn.addEventListener('mouseup', endPress);
      btn.addEventListener('mouseleave', endPress);

      // è§¸æ§äº‹ä»¶
      btn.addEventListener('touchstart', startPress);
      btn.addEventListener('touchend', endPress);
      btn.addEventListener('touchcancel', endPress);
    }

    // å•Ÿå‹•åŠ ç­æ¨¡å¼
    function activateOvertimeMode() {
      isOvertimeMode = true;

      // éš±è—å‡æ—¥æç¤º
      document.getElementById('holidayNotice').style.display = 'none';

      // é‡æ–°è¼‰å…¥ä»»å‹™æ•¸æ“šï¼ˆä»¥åŠ ç­æ¨¡å¼ï¼‰
      google.script.run
        .withSuccessHandler(function(data) {
          if (!data.success) {
            showError(data.error || 'è¼‰å…¥å¤±æ•—');
            return;
          }

          // è¨­å®šå·¥ä½œæ™‚é–“å’Œé™åˆ¶
          workDuration = data.config.workDuration;
          minWorkDuration = data.config.minWorkDuration;
          maxWorkDuration = data.config.maxWorkDuration;
          defaultWorkDuration = data.config.defaultWorkDuration;
          timeRemaining = workDuration * 60;
          updateTimerDisplay();

          // é¡¯ç¤ºä»Šæ—¥çµ±è¨ˆï¼ˆåŠ ç­æ¨™è¨˜ï¼‰
          const stats = data.todayStats;
          document.getElementById('statsBar').innerHTML =
            `<span style="color: #FF6B35;">âš¡ åŠ ç­æ¨¡å¼</span> | ä»Šå¤©å·²ç¶“åŠªåŠ›äº† <strong>${stats.totalTimeUsed}</strong> å€‹å°æ™‚`;

          // é¡¯ç¤ºä»»å‹™åˆ—è¡¨
          tasks = data.tasks;
          renderTaskList();

          // é¡¯ç¤ºä»»å‹™é¸æ“‡é é¢
          document.getElementById('taskSelectPage').style.display = 'block';

          // å„²å­˜åŠ ç­æ¨¡å¼ç‹€æ…‹
          saveState();
        })
        .withFailureHandler(showError)
        .getPomodoroData(true); // å‚³å…¥ true è¡¨ç¤ºåŠ ç­æ¨¡å¼
    }

    // åˆå§‹åŒ– - å…ˆè¼‰å…¥å·²ä¿å­˜çš„ç‹€æ…‹
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success && result.state) {
          // æœ‰å·²ä¿å­˜çš„ç‹€æ…‹ï¼Œå…ˆè¼‰å…¥åŸºç¤æ•¸æ“šå†æ¢å¾©ç‹€æ…‹
          const savedState = result.state;
          google.script.run
            .withSuccessHandler(function(data) {
              initPageWithState(data, savedState);
            })
            .withFailureHandler(showError)
            .getPomodoroData(savedState.isOvertimeMode || false);
        } else {
          // æ²’æœ‰å·²ä¿å­˜çš„ç‹€æ…‹ï¼Œæ­£å¸¸åˆå§‹åŒ–
          google.script.run
            .withSuccessHandler(initPage)
            .withFailureHandler(showError)
            .getPomodoroData();
        }
      })
      .withFailureHandler(function(err) {
        // è¼‰å…¥ç‹€æ…‹å¤±æ•—ï¼Œæ­£å¸¸åˆå§‹åŒ–
        google.script.run
          .withSuccessHandler(initPage)
          .withFailureHandler(showError)
          .getPomodoroData();
      })
      .loadPomodoroState();

    function initPage(data) {
      document.getElementById('loading').style.display = 'none';

      if (!data) {
        showError('è¼‰å…¥å¤±æ•—ï¼šä¼ºæœå™¨æœªå›å‚³è³‡æ–™ï¼Œè«‹ç¢ºèªæ¬Šé™å·²æˆæ¬Š');
        return;
      }

      if (!data.success) {
        showError(data.error || 'è¼‰å…¥å¤±æ•—');
        return;
      }

      // æª¢æŸ¥æ˜¯å¦ç‚ºå‡æ—¥
      if (data.isHoliday) {
        document.getElementById('holidayNotice').style.display = 'block';
        initOvertimeButton();
        return;
      }

      // è¨­å®šå·¥ä½œæ™‚é–“å’Œé™åˆ¶
      workDuration = data.config.workDuration;
      minWorkDuration = data.config.minWorkDuration;
      maxWorkDuration = data.config.maxWorkDuration;
      defaultWorkDuration = data.config.defaultWorkDuration;
      timeRemaining = workDuration * 60;
      updateTimerDisplay();

      // é¡¯ç¤ºä»Šæ—¥çµ±è¨ˆ
      const stats = data.todayStats;
      document.getElementById('statsBar').innerHTML =
        `ä»Šå¤©å·²ç¶“åŠªåŠ›äº† <strong>${stats.totalTimeUsed}</strong> å€‹å°æ™‚`;

      // é¡¯ç¤ºä»»å‹™åˆ—è¡¨
      tasks = data.tasks;
      renderTaskList();

      // é¡¯ç¤ºä»»å‹™é¸æ“‡é é¢
      document.getElementById('taskSelectPage').style.display = 'block';

      // å•Ÿå‹•è¼ªè©¢æª¢æŸ¥ä»»å‹™æ¸…å–®æ›´æ–°
      startRefreshCheck();
    }

    // å¸¶ç‹€æ…‹æ¢å¾©çš„åˆå§‹åŒ–
    function initPageWithState(data, savedState) {
      document.getElementById('loading').style.display = 'none';

      if (!data) {
        showError('è¼‰å…¥å¤±æ•—ï¼šä¼ºæœå™¨æœªå›å‚³è³‡æ–™ï¼Œè«‹ç¢ºèªæ¬Šé™å·²æˆæ¬Š');
        return;
      }

      if (!data.success) {
        showError(data.error || 'è¼‰å…¥å¤±æ•—');
        return;
      }

      // æ¢å¾©åŠ ç­æ¨¡å¼
      isOvertimeMode = savedState.isOvertimeMode || false;

      // æª¢æŸ¥æ˜¯å¦ç‚ºå‡æ—¥ï¼ˆä¸”ä¸æ˜¯åŠ ç­æ¨¡å¼ï¼‰
      if (data.isHoliday && !isOvertimeMode) {
        document.getElementById('holidayNotice').style.display = 'block';
        initOvertimeButton();
        return;
      }

      // è¨­å®šå·¥ä½œæ™‚é–“å’Œé™åˆ¶
      workDuration = savedState.workDuration || data.config.workDuration;
      minWorkDuration = data.config.minWorkDuration;
      maxWorkDuration = data.config.maxWorkDuration;
      defaultWorkDuration = data.config.defaultWorkDuration;

      // é¡¯ç¤ºä»Šæ—¥çµ±è¨ˆ
      const stats = data.todayStats;
      if (isOvertimeMode) {
        document.getElementById('statsBar').innerHTML =
          `<span style="color: #FF6B35;">âš¡ åŠ ç­æ¨¡å¼</span> | ä»Šå¤©å·²ç¶“åŠªåŠ›äº† <strong>${stats.totalTimeUsed}</strong> å€‹å°æ™‚`;
      } else {
        document.getElementById('statsBar').innerHTML =
          `ä»Šå¤©å·²ç¶“åŠªåŠ›äº† <strong>${stats.totalTimeUsed}</strong> å€‹å°æ™‚`;
      }

      // é¡¯ç¤ºä»»å‹™åˆ—è¡¨
      tasks = data.tasks;
      renderTaskList();

      // æ¢å¾©é¸å®šçš„ä»»å‹™ï¼ˆåªæœ‰åœ¨è¨ˆæ™‚ä¸­æˆ–æš«åœæ™‚æ‰æ¢å¾©åˆ°è¨ˆæ™‚å™¨é é¢ï¼‰
      if (savedState.selectedTask && (savedState.isRunning || savedState.isPaused)) {
        // æ‰¾åˆ°åŒ¹é…çš„ä»»å‹™
        const taskIndex = tasks.findIndex(t => t.id === savedState.selectedTask.id);
        if (taskIndex >= 0) {
          selectedTask = tasks[taskIndex];

          // æ¢å¾©è¨ˆæ™‚å™¨ç‹€æ…‹
          startTime = savedState.startTime ? new Date(savedState.startTime) : null;

          // è¨ˆç®—å‰©é¤˜æ™‚é–“
          if (savedState.isRunning && !savedState.isPaused && savedState.timerStartedAt) {
            // è¨ˆç®—è‡ªä¸Šæ¬¡ä¿å­˜ä»¥ä¾†ç¶“éçš„æ™‚é–“
            const timerStartedAt = new Date(savedState.timerStartedAt);
            const now = new Date();
            const elapsedSeconds = Math.floor((now - timerStartedAt) / 1000);
            timeRemaining = Math.max(0, savedState.timeRemaining - elapsedSeconds);

            // å¦‚æœæ™‚é–“å·²ç¶“çµæŸ
            if (timeRemaining <= 0) {
              // å®Œæˆç•ªèŒ„é˜
              showTimerPageRestored();
              completePomodoro();
              return;
            }
          } else {
            timeRemaining = savedState.timeRemaining;
          }

          // é¡¯ç¤ºè¨ˆæ™‚å™¨é é¢
          showTimerPageRestored();

          // æ¢å¾©è¨ˆæ™‚å™¨é‹è¡Œç‹€æ…‹
          if (savedState.isRunning && !savedState.isPaused) {
            isRunning = true;
            isPaused = false;

            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('backBtn').disabled = true;

            // é‡æ–°å•Ÿå‹•è¨ˆæ™‚å™¨
            timerInterval = setInterval(() => {
              timeRemaining--;
              updateTimerDisplay();
              updateProgress();
              saveState(); // å®šæœŸä¿å­˜ç‹€æ…‹

              if (timeRemaining <= 0) {
                completePomodoro();
              }
            }, 1000);
          } else if (savedState.isPaused) {
            isRunning = false;
            isPaused = true;

            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').textContent = 'ç¹¼çºŒ';
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('backBtn').disabled = false;
          }

          updateTimerDisplay();
          updateProgress();
          return;
        }
      }

      // æ²’æœ‰é¸å®šä»»å‹™æˆ–æ‰¾ä¸åˆ°ä»»å‹™ï¼Œé¡¯ç¤ºä»»å‹™é¸æ“‡é é¢
      timeRemaining = workDuration * 60;
      updateTimerDisplay();
      document.getElementById('taskSelectPage').style.display = 'block';

      // å•Ÿå‹•è¼ªè©¢æª¢æŸ¥ä»»å‹™æ¸…å–®æ›´æ–°
      startRefreshCheck();
    }

    // æ¢å¾©æ™‚é¡¯ç¤ºè¨ˆæ™‚å™¨é é¢
    function showTimerPageRestored() {
      document.getElementById('taskSelectPage').style.display = 'none';
      document.getElementById('timerPage').style.display = 'block';
      document.getElementById('currentTaskName').textContent = selectedTask.name;
    }

    function renderTaskList() {
      const container = document.getElementById('taskList');

      if (tasks.length === 0) {
        container.innerHTML = '<div class="empty-message">æ²’æœ‰å¾…è™•ç†çš„ä»»å‹™</div>';
        return;
      }

      container.innerHTML = '';
      tasks.forEach((task, index) => {
        const item = document.createElement('div');
        item.className = 'task-item';

        // å¦‚æœæœ‰åŠå¹´è³‡æºè­¦å‘Šï¼ŒåŠ ä¸Šè­¦å‘Šæ¨£å¼
        if (task.categoryWarning) {
          item.classList.add('category-warning');
        }

        item.onclick = function() { selectTask(index); };

        const statusClass = task.status === 'é€²è¡Œä¸­' ? 'in-progress' : 'pending';
        const priorityText = task.priority ? ` â€¢ ${task.priority}` : '';

        // åˆ†é¡æ¨™ç±¤
        const categoryBadge = task.category ?
          `<span class="task-category ${task.categoryWarning ? 'warning' : ''}">${task.category}</span>` : '';

        item.innerHTML = `
          <div class="task-name">${task.name}</div>
          <div class="task-meta">
            ${categoryBadge}
            <span class="task-status ${statusClass}">${task.status}</span>
            #${task.id}${priorityText}
          </div>
        `;
        container.appendChild(item);
      });
    }

    function selectTask(index) {
      // ç§»é™¤ä¹‹å‰çš„é¸å–
      const items = document.querySelectorAll('.task-item');
      items.forEach(item => item.classList.remove('selected'));

      // é¸å–æ–°çš„
      items[index].classList.add('selected');
      selectedTask = tasks[index];

      // åˆ‡æ›åˆ°è¨ˆæ™‚é é¢
      setTimeout(() => {
        showTimerPage();
        // ä¿å­˜é¸æ“‡çš„ä»»å‹™ç‹€æ…‹
        saveState();
      }, 200);
    }

    function showTimerPage() {
      document.getElementById('taskSelectPage').style.display = 'none';
      document.getElementById('timerPage').style.display = 'block';
      document.getElementById('currentTaskName').textContent = selectedTask.name;

      // æª¢æŸ¥ä¸¦é¡¯ç¤ºåˆ†é¡è­¦å‘Š
      showCategoryWarningIfNeeded();

      // é‡ç½®è¨ˆæ™‚å™¨
      timeRemaining = workDuration * 60;
      updateTimerDisplay();
      updateProgress();
      resetButtons();
    }

    // é¡¯ç¤ºåˆ†é¡è­¦å‘Šï¼ˆå¦‚æœéœ€è¦ï¼‰
    function showCategoryWarningIfNeeded() {
      const warningBanner = document.getElementById('categoryWarningBanner');

      console.log('showCategoryWarningIfNeeded - selectedTask:', selectedTask);
      console.log('categoryWarning:', selectedTask?.categoryWarning, 'category:', selectedTask?.category);

      if (selectedTask && selectedTask.categoryWarning && selectedTask.category) {
        // éœ€è¦å¾å¾Œç«¯ç²å–è©³ç´°çš„è­¦å‘Šè³‡è¨Š
        google.script.run
          .withSuccessHandler(function(data) {
            if (data.success && data.resourceStats && data.resourceStats.categoryLimits) {
              const categoryLimit = data.resourceStats.categoryLimits[selectedTask.category];
              if (categoryLimit && categoryLimit.warning) {
                document.getElementById('warningCategory').textContent = selectedTask.category;
                document.getElementById('warningLimit').textContent = categoryLimit.limit.toFixed(1);
                document.getElementById('warningUsed').textContent = categoryLimit.used6M.toFixed(1);
                warningBanner.style.display = 'block';
              } else {
                warningBanner.style.display = 'none';
              }
            }
          })
          .withFailureHandler(function(error) {
            console.error('ç²å–è­¦å‘Šè³‡è¨Šå¤±æ•—:', error);
            warningBanner.style.display = 'none';
          })
          .getPomodoroData(isOvertimeMode);
      } else {
        warningBanner.style.display = 'none';
      }
    }

    function goBack() {
      if (isRunning) {
        if (!confirm('è¨ˆæ™‚ä¸­ï¼Œç¢ºå®šè¦è¿”å›å—ï¼Ÿ')) {
          return;
        }
        clearInterval(timerInterval);
        isRunning = false;
      }

      document.getElementById('timerPage').style.display = 'none';
      document.getElementById('taskSelectPage').style.display = 'block';

      // å–æ¶ˆé¸å–
      const items = document.querySelectorAll('.task-item');
      items.forEach(item => item.classList.remove('selected'));
      selectedTask = null;
      isPaused = false;

      // æ¸…é™¤ç‹€æ…‹ï¼ˆå› ç‚ºè¿”å›ä»»å‹™åˆ—è¡¨ï¼‰
      clearState();
    }

    function startTimer() {
      // å–æ¶ˆåœæ­¢ç¢ºèªç‹€æ…‹
      cancelStopConfirm();

      if (isPaused) {
        // ç¹¼çºŒè¨ˆæ™‚
        isPaused = false;
      } else {
        // é–‹å§‹æ–°çš„è¨ˆæ™‚
        startTime = new Date();
        timeRemaining = workDuration * 60;
      }

      isRunning = true;
      document.getElementById('startBtn').disabled = true;
      document.getElementById('pauseBtn').disabled = false;
      document.getElementById('stopBtn').disabled = false;
      document.getElementById('backBtn').disabled = true;

      // ä¿å­˜ç‹€æ…‹
      saveState();

      timerInterval = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();
        updateProgress();

        // æ¯ 10 ç§’ä¿å­˜ä¸€æ¬¡ç‹€æ…‹
        if (timeRemaining % 10 === 0) {
          saveState();
        }

        if (timeRemaining <= 0) {
          completePomodoro();
        }
      }, 1000);
    }

    function pauseTimer() {
      clearInterval(timerInterval);
      isRunning = false;
      isPaused = true;

      // å–æ¶ˆåœæ­¢ç¢ºèªç‹€æ…‹
      cancelStopConfirm();

      document.getElementById('startBtn').disabled = false;
      document.getElementById('startBtn').textContent = 'ç¹¼çºŒ';
      document.getElementById('pauseBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
      document.getElementById('backBtn').disabled = false;

      // ä¿å­˜ç‹€æ…‹
      saveState();
    }

    function stopTimer() {
      if (!isStopConfirming) {
        // ç¬¬ä¸€æ¬¡é»æ“Šï¼šé¡¯ç¤ºç¢ºèªç‹€æ…‹
        isStopConfirming = true;
        document.getElementById('stopBtn').textContent = 'ç¢ºå®šåœæ­¢?';
        return;
      }

      // ç¬¬äºŒæ¬¡é»æ“Šï¼šçœŸæ­£åœæ­¢
      clearInterval(timerInterval);
      isRunning = false;
      isPaused = false;
      isStopConfirming = false;

      // è¨ˆç®—å¯¦éš›ç”¨æ™‚æ¯”ä¾‹ï¼ˆç„¡æ¢ä»¶é€²ä½åˆ°å°æ•¸é»å¾Œå…©ä½ï¼‰
      const totalSeconds = workDuration * 60;
      const elapsedSeconds = totalSeconds - timeRemaining;
      const timeUsed = Math.ceil((elapsedSeconds / totalSeconds) * 100) / 100;

      // ä¿å­˜åŠ ç­æ¨¡å¼ç‹€æ…‹ï¼ˆåœæ­¢è¨ˆæ™‚å¾Œä»éœ€ä¿ç•™ï¼‰
      if (isOvertimeMode) {
        const state = {
          isOvertimeMode: true,
          workDuration: workDuration,
          savedAt: new Date().toISOString()
        };
        google.script.run.savePomodoroState(state);
      } else {
        // éåŠ ç­æ¨¡å¼ï¼Œæ¸…é™¤ç‹€æ…‹
        clearState();
      }

      // è¨˜éŒ„åˆ°å·¥æ™‚è¡¨
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showMessage('success', `å·²è¨˜éŒ„ç”¨æ™‚ ${result.timeUsed}`);
            // é‡æ–°è¼‰å…¥è³‡æ–™
            setTimeout(() => {
              google.script.run
                .withSuccessHandler(initPage)
                .withFailureHandler(showError)
                .getPomodoroData(isOvertimeMode);
            }, 2000);
          } else {
            showMessage('error', result.error || 'è¨˜éŒ„å¤±æ•—');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('error', 'è¨˜éŒ„å¤±æ•—: ' + error.message);
        })
        .recordPomodoroCompletion(selectedTask.name, selectedTask.category || '', timeUsed);

      // é‡ç½®
      timeRemaining = workDuration * 60;
      updateTimerDisplay();
      updateProgress();
      resetButtons();

      // è·³å›ä»»å‹™é¸æ“‡é é¢
      document.getElementById('timerPage').style.display = 'none';
      document.getElementById('taskSelectPage').style.display = 'block';

      // å–æ¶ˆé¸å–
      const items = document.querySelectorAll('.task-item');
      items.forEach(item => item.classList.remove('selected'));
      selectedTask = null;
    }

    // å–æ¶ˆåœæ­¢ç¢ºèªç‹€æ…‹
    function cancelStopConfirm() {
      if (isStopConfirming) {
        isStopConfirming = false;
        document.getElementById('stopBtn').textContent = 'åœæ­¢';
      }
    }

    function resetButtons() {
      document.getElementById('startBtn').disabled = false;
      document.getElementById('startBtn').textContent = 'é–‹å§‹';
      document.getElementById('pauseBtn').disabled = true;
      document.getElementById('stopBtn').disabled = true;
      document.getElementById('stopBtn').textContent = 'åœæ­¢';
      document.getElementById('backBtn').disabled = false;
      isStopConfirming = false;
    }

    function completePomodoro() {
      clearInterval(timerInterval);
      isRunning = false;
      isPaused = false;

      // ä¿å­˜åŠ ç­æ¨¡å¼ç‹€æ…‹ï¼ˆå®Œæˆè¨ˆæ™‚å¾Œä»éœ€ä¿ç•™ï¼‰
      if (isOvertimeMode) {
        const state = {
          isOvertimeMode: true,
          workDuration: workDuration,
          savedAt: new Date().toISOString()
        };
        google.script.run.savePomodoroState(state);
      } else {
        // éåŠ ç­æ¨¡å¼ï¼Œæ¸…é™¤ç‹€æ…‹
        clearState();
      }

      // è¨˜éŒ„åˆ°å·¥æ™‚è¡¨ï¼ˆå®Œæˆæ™‚ç”¨æ™‚ç‚º 1ï¼‰
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showMessage('success', `å®Œæˆï¼å·²è¨˜éŒ„ç”¨æ™‚ ${result.timeUsed}`);
            // é‡æ–°è¼‰å…¥è³‡æ–™
            setTimeout(() => {
              google.script.run
                .withSuccessHandler(initPage)
                .withFailureHandler(showError)
                .getPomodoroData(isOvertimeMode);
            }, 2000);
          } else {
            showMessage('error', result.error || 'è¨˜éŒ„å¤±æ•—');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('error', 'è¨˜éŒ„å¤±æ•—: ' + error.message);
        })
        .recordPomodoroCompletion(selectedTask.name, selectedTask.category || '', 1);

      // é‡ç½®
      timeRemaining = workDuration * 60;
      updateTimerDisplay();
      updateProgress();
      resetButtons();
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(timeRemaining / 60);
      const seconds = timeRemaining % 60;
      document.getElementById('timerDisplay').textContent =
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function updateProgress() {
      const totalSeconds = workDuration * 60;
      const elapsed = totalSeconds - timeRemaining;
      const percentage = (elapsed / totalSeconds) * 100;
      document.getElementById('progressFill').style.width = percentage + '%';
    }

    function showError(error) {
      const message = document.getElementById('message');
      message.className = 'message error';
      message.textContent = typeof error === 'string' ? error : error.message;
      document.getElementById('loading').style.display = 'none';
    }

    function showMessage(type, text) {
      const message = document.getElementById('message');
      message.className = 'message ' + type;
      message.textContent = text;

      if (type === 'success') {
        setTimeout(() => {
          message.className = 'message';
        }, 3000);
      }
    }

    // å•Ÿå‹•åˆ·æ–°æª¢æŸ¥
    function startRefreshCheck() {
      // å¦‚æœå·²ç¶“æœ‰æª¢æŸ¥åœ¨é‹è¡Œï¼Œå…ˆåœæ­¢
      if (refreshCheckInterval) {
        clearInterval(refreshCheckInterval);
      }

      // æ¯ 5 ç§’æª¢æŸ¥ä¸€æ¬¡æ˜¯å¦éœ€è¦åˆ·æ–°
      refreshCheckInterval = setInterval(() => {
        checkAndRefreshTasks();
      }, REFRESH_CHECK_INTERVAL);

      console.log('å·²å•Ÿå‹•ä»»å‹™æ¸…å–®åˆ·æ–°æª¢æŸ¥');
    }

    // åœæ­¢åˆ·æ–°æª¢æŸ¥
    function stopRefreshCheck() {
      if (refreshCheckInterval) {
        clearInterval(refreshCheckInterval);
        refreshCheckInterval = null;
        console.log('å·²åœæ­¢ä»»å‹™æ¸…å–®åˆ·æ–°æª¢æŸ¥');
      }
    }

    // æª¢æŸ¥ä¸¦åˆ·æ–°ä»»å‹™æ¸…å–®
    function checkAndRefreshTasks() {
      // åªåœ¨ä»»å‹™é¸æ“‡é é¢æ™‚æª¢æŸ¥
      const taskSelectPage = document.getElementById('taskSelectPage');
      if (taskSelectPage.style.display === 'none') {
        return;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.needRefresh) {
            console.log('åµæ¸¬åˆ°ä»»å‹™æ¸…å–®æ›´æ–°ï¼Œé‡æ–°è¼‰å…¥...', result.timestamp);
            reloadTaskList();
          }
        })
        .withFailureHandler(function(error) {
          console.error('æª¢æŸ¥åˆ·æ–°æ¨™è¨˜å¤±æ•—:', error);
        })
        .checkSidebarRefreshTrigger();
    }

    // é‡æ–°è¼‰å…¥ä»»å‹™æ¸…å–®
    function reloadTaskList() {
      google.script.run
        .withSuccessHandler(function(data) {
          if (!data.success) {
            console.error('é‡æ–°è¼‰å…¥ä»»å‹™å¤±æ•—:', data.error);
            return;
          }

          // æ›´æ–°é…ç½®ï¼ˆåŒ…å«ä½¿ç”¨è€…è¨­å®šçš„å·¥ä½œæ™‚é–“ï¼‰
          workDuration = data.config.workDuration;
          minWorkDuration = data.config.minWorkDuration;
          maxWorkDuration = data.config.maxWorkDuration;
          defaultWorkDuration = data.config.defaultWorkDuration;

          // æ›´æ–°ä»»å‹™åˆ—è¡¨
          tasks = data.tasks;
          renderTaskList();

          // æ›´æ–°çµ±è¨ˆ
          const stats = data.todayStats;
          if (isOvertimeMode) {
            document.getElementById('statsBar').innerHTML =
              `<span style="color: #FF6B35;">âš¡ åŠ ç­æ¨¡å¼</span> | ä»Šå¤©å·²ç¶“åŠªåŠ›äº† <strong>${stats.totalTimeUsed}</strong> å€‹å°æ™‚`;
          } else {
            document.getElementById('statsBar').innerHTML =
              `ä»Šå¤©å·²ç¶“åŠªåŠ›äº† <strong>${stats.totalTimeUsed}</strong> å€‹å°æ™‚`;
          }

          console.log('ä»»å‹™æ¸…å–®å·²åˆ·æ–°');
        })
        .withFailureHandler(function(error) {
          console.error('é‡æ–°è¼‰å…¥ä»»å‹™å¤±æ•—:', error);
        })
        .getPomodoroData(isOvertimeMode);
    }

    // è¨­å®šå°è©±æ¡†å‡½æ•¸
    function showSettingsDialog() {
      const dialog = document.getElementById('settingsDialog');
      const input = document.getElementById('workDurationInput');
      const rangeSpan = document.getElementById('durationRange');
      const message = document.getElementById('settingsMessage');

      // è¨­å®šç•¶å‰å€¼
      input.value = workDuration;
      rangeSpan.textContent = `${minWorkDuration} - ${maxWorkDuration} åˆ†é˜`;

      // æ¸…é™¤è¨Šæ¯
      message.className = 'message';
      message.textContent = '';

      // é¡¯ç¤ºå°è©±æ¡†
      dialog.style.display = 'block';
    }

    function closeSettingsDialog() {
      const dialog = document.getElementById('settingsDialog');
      const message = document.getElementById('settingsMessage');

      // æ¸…é™¤è¨Šæ¯
      message.className = 'message';
      message.textContent = '';

      // éš±è—å°è©±æ¡†
      dialog.style.display = 'none';
    }

    function saveSettings() {
      const input = document.getElementById('workDurationInput');
      const message = document.getElementById('settingsMessage');
      const value = input.value.trim();

      // é©—è­‰æ•´æ•¸
      if (value === '') {
        message.className = 'message error';
        message.textContent = 'è«‹è¼¸å…¥å·¥ä½œæ™‚é–“';
        return;
      }

      const duration = parseFloat(value);

      // æª¢æŸ¥æ˜¯å¦ç‚ºæ•´æ•¸
      if (!Number.isInteger(duration)) {
        message.className = 'message error';
        message.textContent = 'å·¥ä½œæ™‚é–“å¿…é ˆæ˜¯æ•´æ•¸';
        return;
      }

      // æª¢æŸ¥ç¯„åœ
      if (duration < minWorkDuration || duration > maxWorkDuration) {
        message.className = 'message error';
        message.textContent = `å·¥ä½œæ™‚é–“å¿…é ˆåœ¨ ${minWorkDuration} åˆ° ${maxWorkDuration} åˆ†é˜ä¹‹é–“`;
        return;
      }

      // å„²å­˜åˆ°å¾Œç«¯
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            // æ›´æ–°æœ¬åœ°è®Šæ•¸
            workDuration = duration;
            timeRemaining = workDuration * 60;
            updateTimerDisplay();

            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            message.className = 'message success';
            message.textContent = 'è¨­å®šå·²å„²å­˜';

            // 2 ç§’å¾Œé—œé–‰å°è©±æ¡†
            setTimeout(() => {
              closeSettingsDialog();
            }, 2000);
          } else {
            message.className = 'message error';
            message.textContent = result.error || 'å„²å­˜å¤±æ•—';
          }
        })
        .withFailureHandler(function(error) {
          message.className = 'message error';
          message.textContent = 'å„²å­˜å¤±æ•—: ' + error.message;
        })
        .saveUserWorkDuration(duration);
    }
  </script>
</body>
</html>
